
# MySQL Integration Guide for Hostinger

This guide explains how to migrate from MongoDB to MySQL and deploy on Hostinger.

## Overview

Your application has been converted from MongoDB (Mongoose) to MySQL. All database operations now use raw SQL queries through the `mysql2` package with connection pooling.

## How It Works

### 1. Connection Management
- **File**: `lib/mysql.js`
- Creates a connection pool (10 connections max) for efficient database access
- Reuses connections instead of creating new ones for each request
- Automatically manages connection lifecycle

### 2. Data Models
Instead of Mongoose schemas, we now have:
- **SQL Schema**: `database-schema.sql` - defines all tables
- **Helper Functions**: `lib/mysql-helpers.js` - utilities for ID generation and data formatting

### 3. API Routes
All routes in `app/api/v1/` have been updated to:
- Use `getConnection()` instead of `dbConnect()`
- Execute raw SQL queries with parameterized statements (prevents SQL injection)
- Map MySQL column names (snake_case) to JavaScript objects (camelCase)

## Setup on Hostinger

### Step 1: Create MySQL Database in Hostinger

1. Log in to your Hostinger control panel (hPanel)
2. Go to **Databases** → **MySQL Databases**
3. Click **Create New Database**
4. Database name: `eficsy` (or your preferred name)
5. Create a database user with a strong password
6. Grant **ALL PRIVILEGES** to the user for this database
7. Note down:
   - Database name
   - Username
   - Password
   - Host (usually `localhost` or specific hostname)

### Step 2: Import Database Schema

1. In hPanel, go to **phpMyAdmin**
2. Select your database from the left sidebar
3. Click the **SQL** tab
4. Copy the entire contents of `database-schema.sql`
5. Paste into the SQL query box
6. Click **Go** to execute

This creates all necessary tables:
- posts
- categories
- post_categories (junction table)
- projects
- faqs
- testimonials
- job_postings
- contact_messages
- subscribers

### Step 3: Configure Environment Variables

Create a `.env` file in your project root (or set in Hostinger's environment variables):

```env
# MySQL Configuration for Hostinger
MYSQL_HOST=localhost
MYSQL_USER=u123456789_eficsy
MYSQL_PASSWORD=YourStrongPassword123!
MYSQL_DATABASE=u123456789_eficsy

# Note: Replace with your actual Hostinger credentials
# - MYSQL_HOST is usually 'localhost' on Hostinger
# - Username and database follow pattern: u[accountID]_[dbname]
# - Get these from Hostinger's MySQL Databases section
```

**Important**: Never commit `.env` to version control! Add it to `.gitignore`.

### Step 4: Test Locally (Optional)

If you want to test before deploying:

1. Install MySQL locally or use a cloud MySQL instance
2. Set your local credentials in `.env`
3. Run: `npm run dev`
4. Test API endpoints to ensure they work

### Step 5: Deploy to Hostinger

#### Option A: Via Git (Recommended)

1. Push your code to a Git repository (GitHub, GitLab, etc.)
2. In Hostinger, go to **Git** section
3. Connect your repository
4. Set environment variables in Hostinger's control panel
5. Deploy

#### Option B: Manual Upload

1. Build your Next.js app: `npm run build`
2. Upload files via FTP/SFTP to your Hostinger hosting
3. Upload `node_modules` or run `npm install` on the server
4. Set environment variables in Hostinger
5. Start the app

### Step 6: Environment Variables in Hostinger

In Hostinger control panel:
1. Go to **Advanced** → **Environment Variables** (or similar)
2. Add each variable:
   - `MYSQL_HOST`
   - `MYSQL_USER`
   - `MYSQL_PASSWORD`
   - `MYSQL_DATABASE`

## Database Structure

### Tables Overview

**posts**: Blog posts with title, content, slug, etc.
**categories**: Blog categories (Website, AI, etc.)
**post_categories**: Links posts to categories (many-to-many)
**projects**: Portfolio projects
**faqs**: Frequently asked questions
**testimonials**: Client testimonials
**job_postings**: Career opportunities
**contact_messages**: Form submissions
**subscribers**: Newsletter subscribers

### Relationships

- One post can have multiple categories
- One category can belong to multiple posts
- All IDs are 32-character hex strings (generated by `generateId()`)

## How Data Flows

### Example: Creating a Blog Post

1. User fills form in admin panel
2. Frontend sends POST to `/api/v1/posts`
3. API route handler:
   ```javascript
   const db = await getConnection(); // Get connection from pool
   const id = generateId(); // Generate unique ID
   
   // Insert post
   await db.query(
     'INSERT INTO posts (id, title, slug, content, ...) VALUES (?, ?, ?, ...)',
     [id, title, slug, content, ...]
   );
   
   // Link categories
   for (const category of categories) {
     // Find category ID
     // Insert into post_categories junction table
   }
   ```
4. Returns success response with new post ID

### Example: Fetching Posts

1. User visits `/blog`
2. Frontend calls `/api/v1/posts?page=1&pageSize=9`
3. API executes:
   ```sql
   SELECT p.*, GROUP_CONCAT(c.name) as categories
   FROM posts p
   LEFT JOIN post_categories pc ON p.id = pc.post_id
   LEFT JOIN categories c ON pc.category_id = c.id
   WHERE p.published = TRUE
   GROUP BY p.id
   ORDER BY p.published_at DESC
   LIMIT 9 OFFSET 0
   ```
4. Transforms snake_case to camelCase
5. Returns JSON with posts array and pagination info

## Security Features

1. **Parameterized Queries**: All SQL uses `?` placeholders to prevent SQL injection
2. **Connection Pooling**: Limits concurrent connections, prevents resource exhaustion
3. **Input Validation**: Should be added at API level (not yet implemented)
4. **Environment Variables**: Sensitive credentials stored securely

## Common Operations

### Add Sample Data

Use phpMyAdmin or run SQL queries:

```sql
-- Add a category
INSERT INTO categories (id, slug, name) 
VALUES ('cat1', 'website', 'Website');

-- Add a blog post
INSERT INTO posts (id, slug, title, content, published, published_at)
VALUES ('post1', 'my-first-post', 'My First Post', 'Content here', TRUE, NOW());

-- Link post to category
INSERT INTO post_categories (post_id, category_id)
VALUES ('post1', 'cat1');
```

### View All Posts

```sql
SELECT * FROM posts ORDER BY published_at DESC;
```

### View Post with Categories

```sql
SELECT p.title, GROUP_CONCAT(c.name) as categories
FROM posts p
LEFT JOIN post_categories pc ON p.id = pc.post_id
LEFT JOIN categories c ON pc.category_id = c.id
GROUP BY p.id;
```

## Troubleshooting

### "Access denied" error
- Check username/password in `.env`
- Verify user has privileges in Hostinger MySQL panel

### "Table doesn't exist"
- Run `database-schema.sql` in phpMyAdmin
- Check database name in `.env` matches actual database

### Connection timeout
- Check `MYSQL_HOST` - may need specific hostname from Hostinger
- Verify firewall rules allow connections

### Empty results
- Check if tables have data
- Verify `published = TRUE` for posts
- Check date formats

## Performance Tips

1. **Indexes**: Schema includes indexes on frequently queried columns (slug, email, etc.)
2. **Connection Pooling**: Already configured (10 connections)
3. **Limit Queries**: Always use pagination for large result sets
4. **Cache**: Consider adding Redis/caching layer for frequently accessed data

## Migration from MongoDB

Your old MongoDB data needs manual migration:

1. Export from MongoDB: `mongoexport --db eficsy --collection posts --out posts.json`
2. Transform JSON to SQL INSERT statements
3. Import into MySQL using phpMyAdmin or SQL queries

Or use a migration script (not included here).

## Next Steps

1. ✅ Database schema created
2. ✅ All API routes converted to MySQL
3. ⚠️ Add input validation (recommended)
4. ⚠️ Add authentication for admin routes (recommended)
5. ⚠️ Set up automated backups in Hostinger
6. ⚠️ Monitor query performance
7. ⚠️ Add error logging (Sentry, etc.)

## Support

If you encounter issues:
1. Check Hostinger MySQL logs
2. Enable error logging in Next.js
3. Test queries directly in phpMyAdmin
4. Verify environment variables are set correctly

## Files Changed

- ✅ Created: `lib/mysql.js` - Database connection
- ✅ Created: `lib/mysql-helpers.js` - Utility functions
- ✅ Created: `database-schema.sql` - Table definitions
- ✅ Updated: All `/app/api/v1/*/route.js` - API endpoints
- ⚠️ Deprecated: `lib/mongoose.js`, `models/*` - No longer used

You can safely delete MongoDB-related files after confirming MySQL works.
